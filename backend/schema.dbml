// Lab448 Repair Shop - Database Schema (DBML)
// Version: 5.0
// Based on: Db Schema Design.md

Project lab448_system {
  database_type: 'PostgreSQL'
  Note: 'Repair shop automation: Domain-Driven Design v5.0'
}

// =============================================================================
// DOMAIN 1 — IAM (Identity & Access Management)
// =============================================================================

Table roles {
  id varchar [pk, note: 'CUID2']
  code varchar [unique, not null, note: 'Machine key: ADMIN, TECHNICIAN, RECEPTIONIST']
  name varchar [not null, note: 'Display name: Repair Army']
  description text
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table permissions {
  id varchar [pk, note: 'CUID2']
  code varchar [unique, not null, note: 'Namespaced: repair:create, payment:record']
  group varchar [not null, note: 'UI group: Repairs, Invoicing, Inventory']
  description text
  created_at timestamptz [not null]
}

Table role_permissions {
  role_id varchar [not null, ref: > roles.id]
  permission_id varchar [not null, ref: > permissions.id]
  created_at timestamptz [not null]

  indexes {
    (role_id, permission_id) [pk]
  }
}

Table staff_members {
  id varchar [pk, note: 'CUID2']
  role_id varchar [not null, ref: > roles.id]
  name varchar [not null]
  email varchar [unique, not null]
  password_hash varchar [not null]
  phone varchar
  is_active boolean [not null, default: true]
  commission_rate decimal(5,4) [note: 'Live rate; historical rate frozen per work log']
  technician_rank varchar [note: 'JUNIOR / SENIOR / EXPERT / MASTER']
  technician_rank_label varchar [note: 'Display label: Repair Sergeant']
  last_login_at timestamptz
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 2 — CUSTOMER
// =============================================================================

Table customers {
  id varchar [pk, note: 'CUID2']
  name varchar [not null]
  phone_primary varchar
  phone_secondary varchar
  email varchar
  preferred_channel varchar [not null, default: 'SMS', note: 'SMS / WHATSAPP / EMAIL']
  intake_source varchar [not null, default: 'WALK_IN', note: 'WALK_IN / WEBSITE / WHATSAPP / PHONE']
  notes text
  deleted_at timestamptz
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table customer_addresses {
  id varchar [pk, note: 'CUID2']
  customer_id varchar [not null, ref: > customers.id]
  label varchar [not null, note: 'e.g. Home, Office']
  address_line text
  city_district varchar
  nearest_branch varchar
  latitude decimal(10,8)
  longitude decimal(11,8)
  is_default boolean [not null, default: false]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table customer_auth {
  id varchar [pk, note: 'CUID2']
  customer_id varchar [unique, not null, ref: > customers.id]
  email varchar [unique, not null]
  password_hash varchar
  is_active boolean [not null, default: true]
  email_verified_at timestamptz
  verification_token varchar
  token_expires_at timestamptz
  last_login_at timestamptz
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table repair_device_types {
  id varchar [pk, note: 'CUID2']
  parent_id varchar [ref: > repair_device_types.id]
  name varchar [not null]
  sort_order integer [not null, default: 0]
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table customer_devices {
  id varchar [pk, note: 'CUID2']
  customer_id varchar [not null, ref: > customers.id]
  device_type_id varchar [ref: > repair_device_types.id]
  brand varchar
  model_name varchar
  color varchar
  serial_number varchar
  purchase_year smallint
  has_warranty boolean [not null, default: false]
  reported_issue text
  created_at timestamptz [not null]
  updated_at timestamptz [not null]

  Note: 'Physical device owner. Media (intake photos, damage) linked via media_attachments: entity_type=customer_device'
}

// =============================================================================
// DOMAIN 3 — SERVICE CATALOG
// =============================================================================

Table repair_service_types {
  id varchar [pk, note: 'CUID2']
  parent_id varchar [ref: > repair_service_types.id]
  name varchar [not null]
  depth smallint [not null, note: '1=root, 2=mid, 3=leaf']
  default_service_charge decimal(10,2)
  estimated_duration_minutes integer
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 4 — REPAIR WORKFLOW
// =============================================================================

Table repair_orders {
  id varchar [pk, note: 'CUID2']
  ticket_number varchar [unique, not null, note: 'LAB260222-0001']
  customer_id varchar [not null, ref: > customers.id]
  device_id varchar [not null, ref: > customer_devices.id]
  assigned_to_id varchar [ref: > staff_members.id]
  service_type_id varchar [ref: > repair_service_types.id]
  intake_channel varchar [not null, default: 'WALK_IN']
  status varchar [not null]
  priority varchar [not null, default: 'NORMAL']
  intake_notes text
  internal_notes text
  diagnosis_notes text
  resolution_notes text
  default_service_charge decimal(10,2) [not null, default: 0]
  is_locked boolean [not null, default: false]
  has_delivery boolean [not null, default: false]
  pickup_address_id varchar [ref: > customer_addresses.id]
  delivery_address_id varchar [ref: > customer_addresses.id]
  pickup_scheduled_at timestamptz
  delivery_scheduled_at timestamptz
  estimated_completion_at timestamptz
  intake_at timestamptz
  queued_at timestamptz
  in_progress_at timestamptz
  completed_at timestamptz
  delivered_at timestamptz
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table repair_status_logs {
  id varchar [pk, note: 'CUID2']
  repair_order_id varchar [not null, ref: > repair_orders.id]
  from_status varchar
  to_status varchar [not null]
  changed_by_id varchar [not null, ref: > staff_members.id]
  notes text
  created_at timestamptz [not null]
}

Table technician_work_logs {
  id varchar [pk, note: 'CUID2']
  repair_order_id varchar [not null, ref: > repair_orders.id]
  technician_id varchar [not null, ref: > staff_members.id]
  started_at timestamptz [not null]
  ended_at timestamptz
  duration_minutes integer
  work_description text
  commission_rate_at_use decimal(5,4) [not null]
  commission_amount decimal(10,2)
  is_approved boolean [not null, default: false]
  approved_by_id varchar [ref: > staff_members.id]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 5 — INVOICING
// =============================================================================

Table invoices {
  id varchar [pk, note: 'CUID2']
  invoice_number varchar [unique, not null, note: 'INV-260222-0001']
  customer_id varchar [not null, ref: > customers.id]
  status varchar [not null, default: 'DRAFT']
  subtotal_amount decimal(10,2) [not null, default: 0]
  discount_amount decimal(10,2) [not null, default: 0]
  discount_reason varchar
  tax_rate decimal(5,4) [not null, default: 0]
  tax_amount decimal(10,2) [not null, default: 0]
  total_amount decimal(10,2) [not null, default: 0]
  total_paid_amount decimal(10,2) [not null, default: 0]
  staff_commission_amount decimal(10,2) [not null, default: 0]
  shop_revenue_amount decimal(10,2) [not null, default: 0]
  notes text
  issued_at timestamptz
  due_at timestamptz
  is_locked boolean [not null, default: false]
  created_by_id varchar [not null, ref: > staff_members.id]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table charge_types {
  id varchar [pk, note: 'CUID2']
  parent_id varchar [ref: > charge_types.id]
  code varchar [unique, not null, note: 'SERVICE_FEE / PARTS / LABOUR']
  name varchar [not null]
  is_discount boolean [not null, default: false]
  is_tax boolean [not null, default: false]
  sort_order integer [not null, default: 0]
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table invoice_items {
  id varchar [pk, note: 'CUID2']
  invoice_id varchar [not null, ref: > invoices.id]
  repair_order_id varchar [ref: > repair_orders.id]
  parent_item_id varchar [ref: > invoice_items.id]
  charge_type_id varchar [not null, ref: > charge_types.id]
  description varchar [not null]
  quantity decimal(10,3) [not null, default: 1]
  unit_price decimal(10,2) [not null, default: 0]
  amount decimal(10,2) [not null]
  source_part_usage_id varchar [note: 'FK to repair_parts_used.id - set when charge_type=PARTS']
  added_by_id varchar [not null, ref: > staff_members.id]
  created_at timestamptz [not null]
}

Table payments {
  id varchar [pk, note: 'CUID2']
  invoice_id varchar [not null, ref: > invoices.id]
  amount decimal(10,2) [not null]
  payment_method varchar [not null]
  reference_number varchar
  received_by_id varchar [not null, ref: > staff_members.id]
  payment_note text
  received_at timestamptz [not null]
  created_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 6 — INVENTORY
// =============================================================================

Table suppliers {
  id varchar [pk, note: 'CUID2']
  name varchar [not null]
  contact_name varchar
  phone varchar
  email varchar
  address text
  notes text
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table part_locations {
  id varchar [pk, note: 'CUID2']
  code varchar [unique, not null, note: 'e.g. SHELF-A1, BIN-03']
  name varchar [not null]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table repair_parts_catalog {
  id varchar [pk, note: 'CUID2']
  sku varchar [unique]
  name varchar [not null]
  description text
  category varchar
  unit varchar [not null, default: 'pcs']
  available_quantity integer [not null, default: 0]
  reorder_threshold integer
  reorder_quantity integer
  unit_cost_price decimal(10,2)
  unit_sell_price decimal(10,2) [not null, default: 0]
  location_id varchar [ref: > part_locations.id]
  supplier_id varchar [ref: > suppliers.id]
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table repair_parts_used {
  id varchar [pk, note: 'CUID2']
  repair_order_id varchar [not null, ref: > repair_orders.id]
  part_id varchar [not null, ref: > repair_parts_catalog.id]
  quantity decimal(10,3) [not null]
  unit_price_at_use decimal(10,2) [not null]
  unit_cost_at_use decimal(10,2)
  recorded_by_id varchar [not null, ref: > staff_members.id]
  notes text
  created_at timestamptz [not null]
}

// Self-reference for invoice_items link (circular dependency avoidance)
Ref: invoice_items.source_part_usage_id > repair_parts_used.id

Table stock_movements {
  id varchar [pk, note: 'CUID2']
  part_id varchar [not null, ref: > repair_parts_catalog.id]
  movement_type varchar [not null]
  quantity_change integer [not null]
  quantity_after integer [not null]
  reference_id varchar
  reference_type varchar
  notes text
  recorded_by_id varchar [not null, ref: > staff_members.id]
  created_at timestamptz [not null]
}

Table purchase_orders {
  id varchar [pk, note: 'CUID2']
  po_number varchar [unique, not null, note: 'PO-260222-0001']
  supplier_id varchar [not null, ref: > suppliers.id]
  status varchar [not null, default: 'DRAFT']
  ordered_at timestamptz
  expected_at timestamptz
  received_at timestamptz
  notes text
  total_amount decimal(10,2) [not null, default: 0]
  created_by_id varchar [not null, ref: > staff_members.id]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table purchase_order_items {
  id varchar [pk, note: 'CUID2']
  purchase_order_id varchar [not null, ref: > purchase_orders.id]
  part_id varchar [not null, ref: > repair_parts_catalog.id]
  quantity_ordered integer [not null]
  quantity_received integer [not null, default: 0]
  unit_cost decimal(10,2) [not null]
  amount decimal(10,2) [not null]
  created_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 7 — MEDIA ATTACHMENTS
// =============================================================================

Table media_attachments {
  id varchar [pk, note: 'CUID2']
  entity_type varchar [not null, note: 'customer_device, repair_order, invoice, etc.']
  entity_id varchar [not null]
  file_name varchar [not null]
  file_url text [not null]
  file_type varchar
  file_size_bytes integer
  label varchar
  uploaded_by_id varchar [not null, ref: > staff_members.id]
  created_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 8 — COMMUNICATIONS
// =============================================================================

Table message_templates {
  id varchar [pk, note: 'CUID2']
  channel varchar [not null]
  event_type varchar [not null]
  language varchar [not null, default: 'en']
  subject varchar
  body text [not null]
  is_active boolean [not null, default: true]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table whatsapp_conversations {
  id varchar [pk, note: 'CUID2']
  customer_id varchar [ref: > customers.id]
  wa_phone_number varchar [not null]
  wa_contact_name varchar
  status varchar [not null, default: 'OPEN']
  last_message_at timestamptz
  assigned_to_id varchar [ref: > staff_members.id]
  linked_repair_order_id varchar [ref: > repair_orders.id]
  created_at timestamptz [not null]
  updated_at timestamptz [not null]
}

Table communication_logs {
  id varchar [pk, note: 'CUID2']
  customer_id varchar [ref: > customers.id]
  repair_order_id varchar [ref: > repair_orders.id]
  whatsapp_conversation_id varchar [ref: > whatsapp_conversations.id]
  channel varchar [not null]
  direction varchar [not null]
  event_type varchar
  recipient_or_sender varchar [not null]
  message_body text [not null]
  status varchar [not null, default: 'SENT']
  provider_message_id varchar
  provider_response jsonb
  sent_or_received_at timestamptz [not null]
  created_at timestamptz [not null]
}

// =============================================================================
// DOMAIN 9 — SYSTEM
// =============================================================================

Table ref_counters {
  counter_type varchar [pk, note: 'TICKET, INVOICE, PURCHASE_ORDER']
  prefix varchar [not null]
  last_value integer [not null, default: 0]
  pad_length smallint [not null, default: 4]
  updated_at timestamptz [not null]
}

Table audit_events {
  id varchar [pk, note: 'CUID2']
  performed_by_id varchar [ref: > staff_members.id]
  actor_type varchar [not null, default: 'STAFF']
  event_name varchar [not null]
  entity_type varchar [not null]
  entity_id varchar [not null]
  repair_order_id varchar [ref: > repair_orders.id]
  before_snapshot jsonb
  after_snapshot jsonb
  ip_address varchar
  created_at timestamptz [not null]
}
